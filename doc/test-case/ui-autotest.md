# UI 自動化テスト設計

## 1. 概要

Selenium を使用した E2E テストを実装し、ユーザーの実際の操作をシミュレートしてアプリケーションの機能を検証します。

## 2. テストケース一覧

### 2.1 機能テスト一覧

| ID  | テスト項目       | テストケース                                  | 前提条件     | 期待結果                             |
| --- | ---------------- | --------------------------------------------- | ------------ | ------------------------------------ |
| L1  | ログイン失敗     | 無効なユーザー名とパスワードでログイン        | -            | エラーメッセージが表示される         |
| L2  | ログイン成功     | 有効なユーザー名とパスワードでログイン        | -            | バックログページにリダイレクト       |
| P1  | プロジェクト編集 | プロジェクトの説明を変更して保存              | ログイン済み | 変更が保存され、表示が更新される     |
| P2  | プロジェクト編集 | 変更をキャンセルして元に戻す                  | P1 の実行後  | 元の説明に戻る                       |
| B1  | バックログ操作   | ストーリーをバックログからスプリント 2 へ移動 | ログイン済み | スプリント 2 のストーリー数が 1 増加 |
| B2  | バックログ操作   | ストーリーをスプリント 2 からバックログへ移動 | B1 の実行後  | スプリント 2 のストーリー数が 1 減少 |
| K1  | かんばん操作     | ストーリーを Todo から In Progress へ移動     | ログイン済み | In Progress のストーリー数が 1 増加  |
| K2  | かんばん操作     | ストーリーを In Progress から Done へ移動     | K1 の実行後  | Done のストーリー数が 1 増加         |
| K3  | かんばん操作     | ストーリーを Done から Todo へ移動            | K2 の実行後  | Todo のストーリー数が 1 増加         |
| O1  | ログアウト       | ログアウトリンクをクリック                    | ログイン済み | ログイン画面にリダイレクト           |

### 2.2 テストシーケンス

| 順序 | テスト ID | 説明                       | 確認項目                     |
| ---- | --------- | -------------------------- | ---------------------------- |
| 1    | L1        | 無効なログイン             | エラーメッセージ             |
| 2    | L2        | 有効なログイン             | リダイレクト                 |
| 3    | P1        | プロジェクト説明の変更     | 説明文の更新                 |
| 4    | P2        | プロジェクト説明を元に戻す | 元の説明に戻る               |
| 5    | B1        | バックログ → スプリント 2  | ストーリー数の増加           |
| 6    | B2        | スプリント 2→ バックログ   | ストーリー数の減少           |
| 7    | K1        | Todo→In Progress           | ストーリー数の変化           |
| 8    | K2        | In Progress→Done           | ストーリー数の変化           |
| 9    | K3        | Done→Todo                  | ストーリー数の変化           |
| 10   | O1        | ログアウト                 | ログイン画面へのリダイレクト |

## 3. テストデータの準備

### 3.1 データベースの初期化

テストを実行する前に、以下のコマンドでデータベースを初期化し、テストデータを作成します：

```bash
# データベースの初期化とテストデータの作成
flask init-db --with-testdata
```

### 3.2 テストユーザー

テストで使用できるユーザーアカウント：

- 管理者ユーザー

  - ユーザー名: admin
  - パスワード: admin123
  - 権限: 全機能へのアクセス

- テストユーザー
  - ユーザー名: test
  - パスワード: test123
  - 権限: 制限付きアクセス

### 3.3 テストプロジェクト

初期データとして作成されるプロジェクト：

1. GIRA 開発プロジェクト

   - キー: GIRA
   - オーナー: admin
   - 状態: アクティブ
   - スプリント: 2 つ（完了 1、進行中 1）
   - ストーリー: 複数（バックログ、スプリント 1、スプリント 2 に分散）

2. テストプロジェクト
   - キー: TEST
   - オーナー: test
   - 状態: アクティブ

## 4. 実装の特徴

### 4.1 安定性向上策

| 項目               | 実装内容             | 目的                     |
| ------------------ | -------------------- | ------------------------ |
| 待機処理           | WebDriverWait の使用 | 要素の表示を確実に待機   |
| リトライ機能       | 最大 3 回の再試行    | 一時的なエラーから回復   |
| エラーハンドリング | 例外捕捉とログ出力   | 問題の特定と分析を容易に |
| スクリーンショット | エラー時に自動保存   | 問題発生時の状態を記録   |

### 4.2 ドラッグ＆ドロップ実装

| イベント          | 目的            | 実装方法                   |
| ----------------- | --------------- | -------------------------- |
| dragstart         | ドラッグ開始    | DragEvent をディスパッチ   |
| dragover          | ドラッグ中      | DragEvent をディスパッチ   |
| drop              | ドロップ完了    | DragEvent をディスパッチ   |
| sortablejs:change | SortableJS 通知 | CustomEvent をディスパッチ |

### 4.3 テスト結果管理

| 項目               | 内容               | 保存場所            |
| ------------------ | ------------------ | ------------------- |
| 操作ログ           | 詳細な操作内容     | logs/app.log        |
| エラーログ         | エラー情報と例外   | logs/app.log        |
| スクリーンショット | エラー発生時の画面 | tests/result/\*.png |

## 5. 実行環境

### 5.1 必要な環境

| 項目      | 要件              | 備考                     |
| --------- | ----------------- | ------------------------ |
| Python    | 3.8 以上          | 3.11 推奨                |
| ブラウザ  | Chrome            | 最新版推奨               |
| WebDriver | ChromeDriver      | ブラウザと同じバージョン |
| OS        | Windows/Mac/Linux | -                        |

### 5.2 必要なパッケージ

| パッケージ名      | バージョン | 用途           |
| ----------------- | ---------- | -------------- |
| selenium          | 4.x        | ブラウザ操作   |
| webdriver_manager | 最新       | WebDriver 管理 |

### 5.3 実行前の準備

| 項目           | 確認内容                     | 備考                            |
| -------------- | ---------------------------- | ------------------------------- |
| サーバー       | http://127.0.0.1:5000 で起動 | `flask run`で起動               |
| データベース   | テストデータが準備済み       | `flask init-db --with-testdata` |
| テストユーザー | admin/admin123 が利用可能    | テストデータに含まれる          |

## 6. 既知の制限事項

| ID  | 制限事項             | 影響               | 対処方法              |
| --- | -------------------- | ------------------ | --------------------- |
| L1  | カウント表示の非更新 | UI 表示のみ        | 画面リロードで最新化  |
| L2  | 複数要素の重なり     | ドラッグ＆ドロップ | JavaScript で直接操作 |
